<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no" />
    <title>滁州市房价变化分析</title>
    <link rel="stylesheet"
        href="https://js.arcgis.com/4.10/esri/themes/dark/main.css">
    <style>
        html,
        body,
        #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #FFF;
            overflow: hidden;
            font-family: "Trebuchet MS", sans-serif;
        }

        #del {
            position: absolute;
            top: 20px;
            left: 80px;
            font-size: 16px;
            z-index: 10
        }
    </style>
</head>

<body>
    <button id="del">清除渲染</button>
    <div id="map"></div>
    <div id="showdata" style="width: 500px;height: 200px;position: fixed;right:30px;top: 100px;"></div>
    <script src="ArcGISEcharts4.js"></script>
    <script>
        var dojoConfig = {
            parseOnLoad: true,
            packages: [{
                name: "src",
                location: location.pathname.replace(/\/[^/]+$/, "") + "/src"
            }]
        };
    </script>
    <script src="https://js.arcgis.com/4.10/init.js"></script>
    <script src="jquery-3.1.1.min.js"></script>
    <script>
        var map;
        require(["esri/Basemap", "esri/layers/TileLayer", "esri/Map", "esri/views/MapView", "src/EchartsLayer4",
            "dojo/domReady!"
        ], function (Basemap, TileLayer, Map, MapView, EchartsLayer) {
            var layer = new TileLayer({
                url: "http://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineCommunity/MapServer"
            });
            var customBasemap = new Basemap({
                baseLayers: [layer],
                title: "Custom Basemap",
                id: "myBasemap"
            });
            var map = new Map({
                basemap: customBasemap
            });
            var mapView = new MapView({
                center: [118.337731, 32.299211],
                container: 'map',
                map: map,
                zoom: 13
            });
            mapView.when(function () {
                var overlay = new EchartsLayer(mapView, echarts);
                var chartsContainer = overlay.getEchartsContainer();
                var myChart = overlay.initECharts(chartsContainer);
                var data = [
                    {name: '山水人家', value: 193,pricedata:[265,635,452]},
                    {name: '菏泽', value: 194,pricedata:[265,535,453]},
                    {name: '合肥', value: 229,pricedata:[365,435,454]},
                    {name: '武汉', value: 273,pricedata:[165,335,455]},
                    {name: '大庆', value: 279,pricedata:[465,135,456]}
                ];
                var geoCoordMap = {
                    '山水人家': ["118.326907", "32.352524"],
                    '菏泽': ["118.332237", "32.299211"],
                    '合肥': ["118.337731", "32.312873"],
                    '武汉': ["118.317752", "32.296954"],
                    '大庆': ["118.315102", "32.30044"],
                };

                var convertData = function (data) {
                    var res = [];
                    for (var i = 0; i < data.length; i++) {
                        var geoCoord = geoCoordMap[data[i].name];
                        if (geoCoord) {
                            res.push({
                                name: data[i].name,
                                price:data[i].value,
                                pricedata:data[i].pricedata,
                                value: geoCoord.concat(data[i].value)
                            });
                        }
                    }
                    return res;
                };

                option = {
                    title: {
                        text: '滁州市房价变化分析',
                        // subtext: 'Data from 房价',
                        left: 'center',
                        textStyle: {
                            color: '#111'
                        }
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            return data[params.dataIndex].name+"："+data[params.dataIndex].value+"元";
                        }
                    },
                    legend: {
                        orient: 'vertical',
                        top: '50px',
                        right: '50px',
                        data: ['房价', 'Top 5'],
                        textStyle: {
                            color: '#111'
                        }
                    },
                    visualMap: {
                        min: 0,
                        max: 180,
                        calculable: true,
                        inRange: {
                            color: ['#800026', '#BD0026', '#E31A1C', '#FC4E2A', '#FEB24C',
                                '#BD0026', '#BD0026'
                            ],
                            symbolSize: [1, 20]
                        },

                        textStyle: {
                            color: '#111'
                        }
                    },
                    geo: {
                        map: '',
                        label: {
                            emphasis: {
                                show: true
                            }
                        },
                        roam: true,
                        itemStyle: {
                            normal: {
                                areaColor: '#323c48',
                                borderColor: '#111'
                            },
                            emphasis: {
                                areaColor: '#2a333d'
                            }
                        }
                    },
                    series: [
                        {
                            name: '房价',
                            type: 'scatter',
                            coordinateSystem: 'geo',
                            data:convertData(data),
                            symbolSize: function (val) {
                                return val[2] / 10;
                            },
                            label: {
                                normal: {
                                    formatter: '{b}',
                                    position: 'right',
                                    show: false
                                },
                                emphasis: {
                                    show: true
                                }
                            },
                            itemStyle: {
                                normal: {
                                    color: '#ddb926'
                                }
                            }
                        },
                        {
                            name: 'Top 5',
                            type: 'effectScatter',
                            coordinateSystem: 'geo',
                            data: convertData(data.sort(function (a, b) {
                                return b.value - a.value;
                            }).slice(0, 6)),
                            symbolSize: function (val) {
                                return val[2] / 10;
                            },
                            showEffectOn: 'render',
                            rippleEffect: {
                                brushType: 'stroke'
                            },
                            hoverAnimation: true,
                            label: {
                                normal: {
                                    formatter:'{b}',
                                    position: 'right',
                                    show: true
                                }
                            },
                            itemStyle: {
                                normal: {
                                    color: '#f4e925',
                                    shadowBlur: 10,
                                    shadowColor: '#BD0026'
                                }
                            },
                            zlevel: 1
                        }
                    ]
                };
                // 使用刚指定的配置项和数据显示图表。
                overlay.setOption(option);
                var count = 0;
                myChart.on('click', function (parmas) {
                    var myChart = echarts.init(document.getElementById('showdata'));
                        count++;
                        if (count%2==0){
                            myChart.dispose();
                        }
                    option = {
                        title: {
                            text: `滁州市${parmas.data.name}近三年房价走向`,
                        },
                        trigger: 'axis',
                        axisPointer : {
                            type : 'shadow'
                        },
                        xAxis: {
                            axisLabel: {
                                formatter: '{value} 年'
                            },
                            type: 'category',
                            data: ['2017', '2018', '2019']
                        },
                        yAxis: {
                            axisLabel: {
                                formatter: '{value} 元'
                            },
                            color:'#fff',
                            type: 'value'
                        },
                        grid: {
                            left: '1%',
                            right: '1%',
                            bottom: '1%',
                            containLabel: true
                        },
                        series: [{
                            label: {
                                normal: {
                                    show: true
                                }
                            },
                            data: parmas.data.pricedata,
                            type: 'line',
                            smooth: true
                        }]
                    };
                    myChart.setOption(option);
                });
                $("#del").click(function () {
                    overlay.deleteECharts()
                })
            });
        });
    </script>
</body>

</html>