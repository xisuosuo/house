<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>迁徙图 ArcGIS JS 4.10</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.10/esri/themes/dark/main.css">
    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #FFF;
            overflow: hidden;
            font-family: "Trebuchet MS", sans-serif;
        }
        #del{position: absolute;top:20px;left:80px;font-size: 16px;z-index:10}
    </style>
</head>

<body>
<button id="del">清除渲染</button>
<div id="map"></div>
<script src="ArcGISEcharts4.js"></script>
<script>
    var dojoConfig = {
        parseOnLoad: true,
        packages: [{
            name: "src",
            location: location.pathname.replace(/\/[^/]+$/, "")+"/src"
        }]
    };
</script>
<script src="https://js.arcgis.com/4.10/init.js"></script>
<script src="jquery-3.1.1.min.js"></script>
<script>
    var map;
    require(["esri/Basemap","esri/layers/TileLayer","esri/Map","esri/views/MapView", "src/EchartsLayer4", "dojo/domReady!"], function (Basemap, TileLayer, Map, MapView, EchartsLayer) {
        var layer = new TileLayer({
            url: "http://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetPurplishBlue/MapServer"
        });
        var customBasemap = new Basemap({
            baseLayers: [layer],
            title: "Custom Basemap",
            id: "myBasemap"
        });
        var map = new Map({
            basemap: customBasemap
        });
        var mapView = new MapView({
            center: [0, 0],
            container: 'map',
            map: map,
            zoom: 2
        });
        mapView.when(function () {
            var overlay = new EchartsLayer(mapView, echarts);
            var chartsContainer = overlay.getEchartsContainer();
            var myChart = overlay.initECharts(chartsContainer);

            var geoCoordMap = {
                上海: [121.4648, 31.2891],
                尼日利亚: [-4.388361, 11.186148],
                美国洛杉矶: [-118.24311, 34.052713],
                香港邦泰: [114.195466, 22.282751],
                美国芝加哥: [-87.801833, 41.870975],
        
            };
            var BJData = [
                [{
                    name: "尼日利亚",
                    value: 9100
                }, {
                    name: "上海"
                }],
                [{
                    name: "美国洛杉矶",
                    value: 2370
                }, {
                    name: "上海"
                }],
                [{
                    name: "香港邦泰",
                    value: 3130
                }, {
                    name: "上海"
                }],
                [{
                    name: "美国芝加哥",
                    value: 2350
                }, {
                    name: "上海"
                }]
               
            ];
            var convertData = function(data) {
                var res = [];
                for (var i = 0; i < data.length; i++) {
                    var dataItem = data[i];
                    var fromCoord = geoCoordMap[dataItem[0].name];
                    var toCoord = geoCoordMap[dataItem[1].name];
                    if (fromCoord && toCoord) {
                        res.push([{
                            coord: fromCoord,
                            value: dataItem[0].value
                        },
                            {
                                coord: toCoord
                            }
                        ]);
                    }
                }
                return res;
            };

            var series = [];
            [
                ["上海", BJData]
            ].forEach(function(item, i) {
                series.push({
                        type: "lines",
                        zlevel: 2,
                        effect: {
                            show: true,
                            period: 4,
                            trailLength: 0.02,
                            symbol: "arrow",
                            symbolSize: 5
                        },
                        lineStyle: {
                            normal: {
                                color:'#FFC125',
                                width: 1,
                                opacity: 0,
                                curveness: 0.3
                            }
                        },

                        data: convertData(item[1])
                    }, {
                        type: "effectScatter",
                        coordinateSystem: "geo",
                        zlevel: 2,
                        rippleEffect: {
                            period: 4,
                            brushType: "stroke",
                            scale: 4
                        },
                        label: {
                            normal: {
                                show: true,
                                position: "right",
                                offset: [5, 0],
                                formatter: "{b}"
                            },
                            emphasis: {
                                show: true
                            }
                        },
                        symbol: "circle",
                        symbolSize: function(val) {
                            return 4 + val[2] / 1000;
                        },
                        itemStyle: {
                            normal: {
                                color: "#FFC125",
                                show: false,
                            }
                        },
                        data: item[1].map(function(dataItem) {
                            return {
                                name: dataItem[0].name,
                                value: geoCoordMap[dataItem[0].name].concat([dataItem[0].value])
                            };
                        })
                    },
                    //被攻击点
                    {
                        type: "scatter",
                        coordinateSystem: "geo",
                        zlevel: 2,
                        rippleEffect: {
                            period: 4,
                            brushType: "stroke",
                            scale: 4
                        },
                        label: {
                            normal: {
                                show: true,
                                position: "right",
                                color: "#00ffff",
                                formatter: "{b}",
                                textStyle: {
                                    color: "#9966cc"
                                }
                            },
                            emphasis: {
                                show: true
                            }
                        },
                        symbol: "pin",
                        symbolSize: 30,
                        itemStyle: {
                            normal: {
                                show: true,
                                color: "#9966cc"
                            }
                        },
                        data: [{
                            name: item[0],
                            value: geoCoordMap[item[0]].concat([100])
                        }]
                    }
                );
            });

            option = {
                tooltip: {
                    trigger: "item",
                    backgroundColor: "#1540a1",
                    borderColor: "#FFFFCC",
                    showDelay: 0,
                    hideDelay: 0,
                    enterable: true,
                    transitionDuration: 0,
                    extraCssText: "z-index:100",
                    formatter: function(params,) {
                        var res = "";
                        var name = params.name;
                        var value = params.value[params.seriesIndex + 1];
                        res =
                            "<span style='color:#fff;'>" +
                            name +
                            "</span><br/>数据：" +
                            value;
                        return res;
                    }
                },
//                visualMap: {
//                    //图例值控制
//                    min: 0,
//                    max: 10000,
//                    show: false,
//                    calculable: true,
//                    color: ["#0bc7f3"],
//                    textStyle: {
//                        color: "#fff"
//                    },
//
//                },
                geo: {
                    map: "",
                    label: {
                        emphasis: {
                            show: false
                        }
                    },
                    roam: true,
                    itemStyle: {
                        normal: {
                            color: "#04284e", //地图背景色
                            borderColor: "#5bc1c9" //省市边界线
                        },
                        emphasis: {
                            color: "rgba(37, 43, 61, .5)" //悬浮背景
                        }
                    }
                },

                series: series
            };
            // 使用刚指定的配置项和数据显示图表。
            overlay.setOption(option);
            $("#del").click(function(){
                overlay.deleteECharts()
            })
        });
    });
</script>
</body>
</html>